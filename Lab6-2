#include <avr/io.h>

void SPI_MasterInit(void) {
  // PB2 = SS, PB3 = MOSI, PB5 = SCK as outputs
  DDRB |= (1 << PB2) | (1 << PB3) | (1 << PB5);
  // PB4 = MISO as input
  DDRB &= ~(1 << PB4);

  // Enable SPI, Master mode, Mode 3, clock = Fosc/16
  // SPE=1, MSTR=1, CPOL=1, CPHA=1, SPR0=1, SPR1=0
  SPCR = (1 << SPE) | (1 << MSTR) | (1 << CPOL)
       | (1 << CPHA) | (1 << SPR0);

  // No double speed (SPI2X = 0) â†’ Fosc/16
  SPSR &= ~(1 << SPI2X);
}

void SPI_MasterTransmit(uint8_t data) {
  SPDR = data;                    // start transmission
  while (!(SPSR & (1 << SPIF))) { // wait until done
    // wait
  }
}

int main(void) {
  SPI_MasterInit();

  while (1) {
    SPI_MasterTransmit(0xAA);   // send test pattern
  }
}
